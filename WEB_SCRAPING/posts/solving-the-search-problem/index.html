<!doctype html>
<html lang="en">
  
<!-- Mirrored from www.abeautifulsite.net/posts/solving-the-search-problem/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 Oct 2021 09:00:03 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solving the search problem</title>
    <meta name="description" content="A different approach for searching in Postleaf.">
    <link rel="stylesheet" href="../../css/index.css">
    <link rel="alternate" href="../../feed/feed.xml" type="application/atom+xml" title="A Beautiful Site">
    <link rel="alternate" href="../../feed/feed.json" type="application/json" title="A Beautiful Site">
    <link rel="icon" href="../../images/logos/leaf.svg" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.gstatic.com/">
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" rel="stylesheet">
  </head>
  <body class="post-template">
    <header>
      <a href="../../index.html" class="header-link">
        <img src="../../images/logos/wordmark.svg" alt="A Beautiful Site" class="wordmark">
      </a>

      <nav class="nav">
          <a class="nav-item" href="../../index.html">
            Home
          </a>
          <a class="nav-item" href="../../tags/index.html">
            Tags
          </a>
          <a class="nav-item" href="../index.html">
            Archive
          </a>
          <a class="nav-item" href="../../about/index.html">
            About
          </a>
        <a class="nav-item" href="#search" arial-label="Search" title="Press / to search" data-site-search>
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
          </svg>
        </a>
      </nav>
    </header>

    <main class="content">
      
<hr>

<article class="post">
  <h1>Solving the search problem</h1>

  <div class="post-date">
    <time datetime="2017-02-06">
      February 06, 2017
    </time>
    &bull;
    3 min read
  </div>

  

  <p>I recently wrote about <a href="../index-2.html">using an ORM</a> and how it allowed me to support five different database platforms with minimal effort. There is, however, one feature that even Sequelize couldn't tackle for me: <em>full-text search</em></p>
<p>A full-text search is typically a database feature that lets you locate content just like you would in a search engine. Ideally, the results are ranked by some sort of relevancy score.</p>
<p>The problem is that not all databases support full-text search out of the box, and the ones that do don't necessarily rank results the same way.</p>
<h2 id="searching-with-sqlite">Searching with SQLite <a class="direct-link" href="#searching-with-sqlite">#</a></h2>
<p>I'm using SQLite at the moment for development, and while it supports full-text search, you have to use one of three possible extensions (FTS3, FTS4, FTS5) that must be compiled along with SQLite.</p>
<p>Having three extensions is confusing enough, much less making users compile their own version of SQLite just to run Postleaf. And none of this accounts for the four other database dialects that I'd like to support.</p>
<h2 id="searching-with-mysql">Searching with MySQL <a class="direct-link" href="#searching-with-mysql">#</a></h2>
<p>The previous version of Postleaf ran on top of MySQL, which has a built-in full-text search. Once you create an index, you can search against content with relative ease. Results are reasonably relevant, but not amazing.</p>
<p>Some quirks â€” it ignores any term that's three letters or less. So a search for &quot;cat&quot; will always yield zero results. And if you want to rank a post's title higher than its content (a weighted search), you have to do the math and write the raw SQL yourself. Lame.</p>
<h2 id="solving-search-is-hard!">Solving Search is hard! <a class="direct-link" href="#solving-search-is-hard!">#</a></h2>
<p>It's true, search is hard, but this problem is much bigger than Postleaf. Ghost has a <a href="https://github.com/TryGhost/Ghost/issues/5321">two year old issue</a> about it and a lot of people complain that WordPress searches <a href="http://www.noupe.com/wordpress/improving-the-default-search-experience-in-wordpress-75862.html">lack relevance</a>.</p>
<p>Sure, if you focus on one particular database or avoid full-text altogether, you can achieve a search that will yield somewhat usable results. It will work, but it won't be amazing. I think that's because databases really weren't meant to do this type of thing.</p>
<p>A more effective way to solve this problem is with a dedicated search engine such as <a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a>. Elasticsearch delivers fast, relevant results which is just what we're looking for! Except, of course, it's written in Java and can be somewhat difficult to setup.</p>
<p>Making a complex third-party app a dependency of Postleaf was simply not going to happen. And while there are other options out there, they tend to be more complicated than they're worth for the simple search that I needed for Postleaf.</p>
<h2 id="experimenting-with-lunr">Experimenting with Lunr <a class="direct-link" href="#experimenting-with-lunr">#</a></h2>
<p>After some searching around, I began experimenting with a JavaScript library called <a href="http://lunrjs.com/">Lunr</a>. Lunr can be used with Node.js apps or directly in the browser.</p>
<p>Essentially, you define an index with the fields you want to search. You can weight a field using the boost option:</p>
<pre><code class="language-js">var index = lunr(function() {
  this.field('title', { boost: 10 });
  this.field('content');
  this.ref('id');
});
</code></pre>
<p>Then you add items to the index:</p>
<pre><code class="language-js">index.add({
  id: 1,
  title: 'Lorem Ipsum',
  content: 'Lorem ipsum dolor...'
});
</code></pre>
<p>And then you can search quite easily:</p>
<pre><code class="language-js">index.search('lorem ipsum');
</code></pre>
<p>Lunr is fast, lightweight, and JavaScript. And it's results are spot on! I immediately knew it would be a key component to my full-text search solution, but some challenges still remained.</p>
<h2 id="implementing-lunr-in-postleaf">Implementing Lunr in Postleaf <a class="direct-link" href="#implementing-lunr-in-postleaf">#</a></h2>
<p>My initial approach to implementing Lunr turned out to be expensive. I wanted to see how fast fetching, indexing, and searching would be on the fly. It looked something like this:</p>
<ol>
<li>Fetch id, title, and content of all posts when a request comes in.</li>
<li>Create a Lunr index.</li>
<li>Add each post to the index.</li>
<li>Search the index for the user's query.</li>
<li>eturn all posts that matched the IDs that Lunr had returned.</li>
<li>DesTroy the Lunr index.</li>
</ol>
<p>This happened on every single request requiring a search. Obviously it wasn't ideal, but I was surprised at how well it performed even for 1,000 posts. At some point after that, the delay became somewhat noticeable (I think it was 2-3 seconds or so per query).</p>
<p>I ended up optimizing my approach so the search index is only built once when the app starts. The index persists in memory and, using <a href="http://docs.sequelizejs.com/en/latest/docs/hooks/">Sequelize hooks</a>, it stays up to date when you add, update, or delete posts.</p>
<p>Since the search happens 100% in memory, it's incredibly fast.</p>
<p>The biggest drawback to this approach is, of course, keeping the search index in memory. However, for 10,000 posts I extrapolated a footprint of just under 30MB. If you have that many posts, I hope your VPS is strong enough to handle it. ðŸ˜†</p>
<p>Needless to say, the Postleaf rebuild is shipping with a fast, relevant, database-agnostic full-text search thanks to Lunr and a very clever Node.js implementation.</p>


  <div class="tags">
    
  <a href="../../tags/postleaf/index.html" class="post-tag">postleaf</a>
  <a href="../../tags/lunr/index.html" class="post-tag">lunr</a>

  </div>
</article>

<hr>

<footer class="post-footer">
  <img src="http://0.gravatar.com/avatar/bf1b3b95fd5b096a3592247c29667b33?s=512" alt="Photo of Cory" class="avatar avatar-small">

  <p>
    Written by <a href="../../index-4.html">Cory LaViska</a>, a software engineer and UX architect responsible for
    <a href="https://shoelace.style/">Shoelace.style</a>, <a href="https://www.surrealcms.com/">Surreal&nbsp;CMS</a>, and
    other <a href="https://github.com/claviska">open source things</a>.
  </p>

  <p>
    You can follow Cory on <a href="https://twitter.com/claviska">Twitter</a> and <a href="https://github.com/claviska">GitHub</a>.
  </p>
</footer>

<hr>

<nav class="post-nav">
    <a href="../moving-to-nodejs/index.html" class="post-nav-previous">
      <small>Previous post</small>
      Moving to Node.js
    </a>
  
    <a href="../using-an-orm/index.html" class="post-nav-next">
      <small>Up next</small>
      Using an ORM
    </a>
  
</nav>

    </main>

    <div class="site-search" hidden>
      <div class="site-search-panel">
        <header class="site-search-header">
          <input type="text" placeholder="Search" class="site-search-input">
        </header>
        <div class="site-search-body">
          <ul class="site-search-results"></ul>
        </div>
      </div>
    </div>

    <script src="../../../cdn.jsdelivr.net/npm/lunr%402.3.9/lunr.min.js"></script>
    <script src="../../js/search.js"></script>

    <script defer src="../../js/greeting.js"></script>
    <script defer src="../../../cdn.jsdelivr.net/gh/PrismJS/prism%401.23.0/prism.js"></script>
    <script defer src="../../../cdn.jsdelivr.net/npm/prismjs%401.23.0/components/prism-bash.js"></script>
    <script defer src="../../../cdn.jsdelivr.net/npm/prismjs%401.23.0/components/prism-markup-templating.js"></script>
    <script defer src="../../../cdn.jsdelivr.net/npm/prismjs%401.23.0/components/prism-php.js"></script>
    <script defer src="../../../cdn.jsdelivr.net/npm/prismjs%401.23.0/components/prism-typescript.js"></script>

    <!-- Current page: /posts/solving-the-search-problem/ -->
  </body>

<!-- Mirrored from www.abeautifulsite.net/posts/solving-the-search-problem/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 Oct 2021 09:00:03 GMT -->
</html>
